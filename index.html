
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D íë¸Œ ì½”ì¸ ì‹œë®¬ë ˆì´í„°</title>
    <!-- Tailwind CSS ë¡œë“œ --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js (3D ë¼ì´ë¸ŒëŸ¬ë¦¬) ë¡œë“œ --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js (ê·¸ë˜í”„ ë¼ì´ë¸ŒëŸ¬ë¦¬) ë¡œë“œ --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 'Inter' í°íŠ¸ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš© */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* 3D ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ (renderer.domElement) */
        canvas { display: block; }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .history-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; }
        .history-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; }

        /* ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-disabled { background-color: #4b5563 !important; cursor: not-allowed; opacity: 0.7; }
        
        /* íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ (v2) */
        .tab-active { border-bottom-color: #60a5fa !important; color: #60a5fa !important; font-weight: 600; }
        
        #login-modal .tab-active {
            border-bottom-color: #60a5fa !important;
            color: #60a5fa !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="countdown-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-500 text-black text-center p-2 font-bold z-50">
        <div>v.0.4.0 ë‚ ì”¨ ì—…ë°ì´íŠ¸ê¹Œì§€ <span id="countdown-timer"></span> ë‚¨ì•˜ìŠµë‹ˆë‹¤!</div>
        <div id="code-announcement" class="hidden text-sm"></div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex justify-center items-center z-[100]">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 border border-gray-700">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center text-white mb-2">ë¡œê·¸ì¸</h2>
                <p class="text-center text-gray-400 mb-6">ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">ì´ë©”ì¼</label>
                    <input type="email" id="login-email" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button id="login-submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">ë¡œê·¸ì¸</button>
                <p class="text-center text-sm text-gray-400 mt-4">ê³„ì •ì´ ì—†ë‚˜ìš”? <button id="show-signup-button" class="font-medium text-blue-400 hover:text-blue-300">íšŒì›ê°€ì… í•˜ì„¸ìš”</button></p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                 <h2 class="text-3xl font-bold text-center text-white mb-2">íšŒì›ê°€ì…</h2>
                 <p class="text-center text-gray-400 mb-6">ìƒˆ ê³„ì •ì„ ë§Œë“¤ì–´ ì‹œì‘í•˜ì„¸ìš”.</p>
                 <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-2">ì´ë©”ì¼</label>
                    <input type="email" id="signup-email" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signup-password" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <button id="signup-submit-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg">íšŒì›ê°€ì…</button>
                <p class="text-center text-sm text-gray-400 mt-4">ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? <button id="show-login-button" class="font-medium text-blue-400 hover:text-blue-300">ë¡œê·¸ì¸ í•˜ì„¸ìš”</button></p>
            </div>
            
            <p id="auth-error-message" class="text-red-400 text-center mt-4 text-sm h-5"></p>
        </div>
    </div>
    
    <main id="main-content" class="hidden">
        <!-- 
        ==========================================
        v.0.3.0 ê²Œì„ ì»¨í…Œì´ë„ˆ
        ==========================================
        -->
        <div id="v0.3.0-container" class="hidden">
            <div class="flex flex-col lg:flex-row w-full h-screen">
                <!-- ì™¼ìª½: 3D ë·°ì–´ --><div id="v0.3.0-canvas-container" class="lg:w-1/2 w-full h-1/2 lg:h-full relative bg-black transition-all duration-300">
                    <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl z-20">
                        <div><h2 class="text-sm font-semibold text-blue-300 uppercase">CUBE-KRW</h2><div id="v0.3.0-current-price" class="text-3xl font-bold text-white">10,000 KRW</div><div id="v0.3.0-price-change" class="text-lg font-medium text-gray-300">-</div></div>
                        <div id="v0.3.0-lunar-price-display" class="mt-4"><h2 class="text-sm font-semibold text-purple-300 uppercase">LUNAR-KRW</h2><div id="v0.3.0-current-lunar-price" class="text-3xl font-bold text-white">20,000 KRW</div><div id="v0.3.0-lunar-price-change" class="text-lg font-medium text-gray-300">-</div></div>
                        <div class="mt-4"><h2 class="text-sm font-semibold text-pink-300 uppercase">PRISM-KRW</h2><div id="v0.3.0-current-prism-price" class="text-3xl font-bold text-white">50,000 KRW</div><div id="v0.3.0-prism-price-change" class="text-lg font-medium text-gray-300">-</div></div>
                        <div id="v0.3.0-time-container" class="mt-4"><h2 class="text-sm font-semibold text-gray-300 uppercase">GAME TIME</h2><div id="v0.3.0-game-time" class="text-xl font-bold text-white">09:00 â˜€ï¸</div></div>
                    </div>
                    <div class="absolute bottom-4 left-4 flex flex-col md:flex-row gap-4 items-start md:items-end z-20">
                        <div id="v0.3.0-passive-income-display" class="bg-black/50 backdrop-blur-sm p-3 rounded-lg shadow-xl hidden"><h3 class="text-sm font-semibold text-green-300">íŒ¨ì‹œë¸Œ ìˆ˜ì…</h3><div id="v0.3.0-income-per-second" class="text-lg font-bold text-white">+0 KRW / sec</div></div>
                        <div id="v0.3.0-upgrade-prism-section" class="bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl text-center hidden"><h3 class="text-lg font-bold mb-2 text-pink-300">í”„ë¦¬ì¦˜ ì—…ê·¸ë ˆì´ë“œ</h3><p class="text-gray-300 text-sm mb-3">íë¸Œë¥¼ í”„ë¦¬ì¦˜ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ<br>(í•„ìš”: 100 PRISM)</p><button id="v0.3.0-upgrade-prism-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg">100 PRISMì— ì—…ê·¸ë ˆì´ë“œ</button></div>
                        <div id="v0.3.0-upgrade-lunar-section" class="bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl text-center hidden"><h3 class="text-lg font-bold mb-2 text-purple-300">ë‹¬ë¹› ê°•í™”</h3><p class="text-gray-300 text-sm mb-3">íë¸Œì— ë‹¬ì˜ í˜ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p><button id="v0.3.0-upgrade-lunar-blessing-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Lunar Blessing (200 LUNAR)</button></div>
                    </div>
                    <div id="v0.3.0-cube-purchase-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-center items-center text-center p-4 z-10"><div id="v0.3.0-buy-cube-section"><h3 class="text-2xl font-bold mb-2">3D íë¸Œ ì ê¸ˆ í•´ì œ</h3><p class="text-gray-300 mb-4">íë¸Œë¥¼ í™œì„±í™”í•˜ê³  ì´ˆë‹¹ 100 KRWë¥¼ ìƒì‚°í•˜ë ¤ë©´ 1,000,000 KRWê°€ í•„ìš”í•©ë‹ˆë‹¤.</p><button id="v0.3.0-buy-cube-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">1,000,000 KRWì— êµ¬ë§¤</button></div></div>
                </div>
                <!-- ì˜¤ë¥¸ìª½: ëŒ€ì‹œë³´ë“œ --><div id="v0.3.0-dashboard" class="lg:w-1/2 w-full h-1/2 lg:h-full p-6 bg-gray-800 flex flex-col gap-4 overflow-y-auto custom-scrollbar transition-all duration-300">
                    <h1 id="v0.3.0-game-title" class="text-3xl font-bold text-center text-white mb-2">íë¸Œ ì½”ì¸ ì‹œë®¬ë ˆì´í„°</h1>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-assets"><h3 class="text-lg font-semibold text-white">ë‚´ ìì‚° í˜„í™©</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-assets-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-assets" class="px-4 pb-4"><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">í˜„ê¸ˆ (KRW)</h3><div id="v0.3.0-user-cash" class="text-2xl font-bold text-blue-400">100,000</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">íë¸Œ (CUBE)</h3><div id="v0.3.0-user-cubes" class="text-2xl font-bold text-blue-400">0</div></div><div id="v0.3.0-lunar-asset-display" class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">ë£¨ë‚˜ (LUNAR)</h3><div id="v0.3.0-user-lunar" class="text-2xl font-bold text-purple-400">0</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">í”„ë¦¬ì¦˜ (PRISM)</h3><div id="v0.3.0-user-prisms" class="text-2xl font-bold text-pink-400">0</div></div></div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-trade"><h3 class="text-lg font-semibold text-white">ë§¤ìˆ˜ / ë§¤ë„</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-trade-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-trade" class="px-4 pb-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-600 p-4 rounded-lg"><label class="text-lg font-semibold text-blue-300">CUBE ê±°ë˜</label><input type="number" id="v0.3.0-amount-input-cube" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="CUBE ìˆ˜ëŸ‰"><div class="grid grid-cols-2 gap-4 mt-4"><button id="v0.3.0-buy-button-cube" class="w-full bg-green-600 hover:bg-green-700 font-bold p-3 rounded-lg">ë§¤ìˆ˜</button><button id="v0.3.0-sell-button-cube" class="w-full bg-red-600 hover:bg-red-700 font-bold p-3 rounded-lg">ë§¤ë„</button></div></div><div id="v0.3.0-lunar-trade-section" class="bg-gray-600 p-4 rounded-lg"><label class="text-lg font-semibold text-purple-300">LUNAR ê±°ë˜</label><input type="number" id="v0.3.0-amount-input-lunar" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="LUNAR ìˆ˜ëŸ‰"><div class="grid grid-cols-2 gap-4 mt-4"><button id="v0.3.0-buy-button-lunar" class="w-full bg-green-600 hover:bg-green-700 font-bold p-3 rounded-lg">ë§¤ìˆ˜</button><button id="v0.3.0-sell-button-lunar" class="w-full bg-red-600 hover:bg-red-700 font-bold p-3 rounded-lg">ë§¤ë„</button></div></div><div class="bg-gray-600 p-4 rounded-lg md:col-span-2"><label class="text-lg font-semibold text-pink-300">PRISM ê±°ë˜</label><input type="number" id="v0.3.0-amount-input-prism" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="PRISM ìˆ˜ëŸ‰"><div class="grid grid-cols-2 gap-4 mt-4"><button id="v0.3.0-buy-button-prism" class="w-full bg-green-600 hover:bg-green-700 font-bold p-3 rounded-lg">ë§¤ìˆ˜</button><button id="v0.3.0-sell-button-prism" class="w-full bg-red-600 hover:bg-red-700 font-bold p-3 rounded-lg">ë§¤ë„</button></div></div></div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-charts"><h3 class="text-lg font-semibold text-white">ì‹¤ì‹œê°„ ì°¨íŠ¸</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-charts-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-charts" class="px-4 pb-4"><nav class="flex border-b border-gray-600 mb-4"><button id="v0.3.0-chart-tab-cube" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white tab-active">CUBE</button><button id="v0.3.0-chart-tab-lunar" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">LUNAR</button><button id="v0.3.0-chart-tab-prism" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">PRISM</button></nav><div id="v0.3.0-chart-cube-container" class="h-40"><canvas id="v0.3.0-price-chart"></canvas></div><div id="v0.3.0-chart-lunar-container" class="h-40 hidden"><canvas id="v0.3.0-lunar-price-chart"></canvas></div><div id="v0.3.0-chart-prism-container" class="h-40 hidden"><canvas id="v0.3.0-prism-price-chart"></canvas></div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-history"><h3 class="text-lg font-semibold text-white">ê±°ë˜ ë‚´ì—­</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-history-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-history" class="px-4 pb-4"><div id="v0.3.0-transaction-history" class="h-32 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">...</div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-news"><h3 class="text-lg font-semibold text-white">ì‹¤ì‹œê°„ ë‰´ìŠ¤ (ì˜ˆì¸¡)</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-news-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-news" class="px-4 pb-4"><div id="v0.3.0-news-feed" class="h-24 overflow-y-auto custom-scrollbar pr-2 bg-gray-600 rounded-lg p-2">...</div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-jobs"><h3 class="text-lg font-semibold text-white">ë‹¤ì–‘í•œ ëˆë²Œì´</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-jobs-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-jobs" class="px-4 pb-4"><div class="grid grid-cols-1 gap-4"><button id="v0.3.0-job-paper" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold p-3 rounded-lg"><span id="v0.3.0-job-paper-text">íì§€ ì¤ê¸° (+500)</span><span id="v0.3.0-job-paper-timer" class="text-sm ml-2"></span></button><button id="v0.3.0-job-starcatching" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-lg hidden">ë°¤í•˜ëŠ˜ì— ë³„ ë”°ê¸°<span id="v0.3.0-job-starcatching-timer" class="text-sm ml-2"></span></button></div></div></div>
                    <div id="v0.3.0-sleep-section" class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-sleep"><h3 class="text-lg font-semibold text-white">ìˆ˜ë©´</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-sleep-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-sleep" class="px-4 pb-4 hidden"><div class="flex items-center gap-4"><p class="text-gray-300 text-sm flex-grow">ë°¤ì— ì ì„ ìì„œ ì•„ì¹¨ 8ì‹œê¹Œì§€ ì‹œê°„ì„ ê±´ë„ˆëœë‹ˆë‹¤.</p><button id="v0.3.0-sleep-button" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg btn-disabled">ìˆ˜ë©´</button></div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-trophies">
                            <h3 class="text-lg font-semibold text-white">ì´ë²¤íŠ¸ íŠ¸ë¡œí”¼</h3>
                            <svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-trophies-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v0.3.0-content-trophies" class="px-4 pb-4 hidden">
                            <div id="v0.3.0-trophy-list" class="space-y-3 mb-4">
                                <!-- JS will populate this -->
                            </div>
                            <div class="border-t border-gray-600 pt-3">
                                <h4 class="text-md font-semibold text-blue-300 mb-2">ì´ íš¨ê³¼</h4>
                                <div id="v0.3.0-trophy-effects" class="text-sm text-gray-300">
                                    <!-- JS will populate this -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-code"><h3 class="text-lg font-semibold text-white">ì½”ë“œ ì…ë ¥</h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-code-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-code" class="px-4 pb-4"><div class="flex gap-4"><input type="text" id="v0.3.0-code-input" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì½”ë“œ ì…ë ¥"><button id="v0.3.0-code-submit-button" class="bg-purple-600 hover:bg-purple-700 font-bold py-2 px-6 rounded-lg">ì…ë ¥</button></div></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-updates"><h3 class="text-lg font-semibold text-white">ì—…ë°ì´íŠ¸ ë‚´ì—­ <span id="v0.3.0-version-display"></span></h3><svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-updates-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v0.3.0-content-updates" class="px-4 pb-4 hidden"><ul id="v0.3.0-update-list" class="list-disc list-inside text-gray-300 text-sm space-y-1"></ul></div></div>
                    <div class="bg-gray-700 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v0.3.0-toggle-settings">
                            <h3 class="text-lg font-semibold text-white">ì„¤ì •</h3>
                            <svg class="w-5 h-5 text-gray-400" id="v0.3.0-toggle-settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v0.3.0-content-settings" class="px-4 pb-4 hidden">
                            <button id="v0.3.0-logout-button" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="v0.3.0-notification" class="fixed bottom-6 right-6 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50"></div>
        </div>

        <!-- 
        ==========================================
        v.0.4.0 ê²Œì„ ì»¨í…Œì´ë„ˆ
        ==========================================
        -->
        <div id="v1.0.0-container" class="hidden">
            <div class="flex flex-col lg:flex-row w-full h-screen">
                <!-- ì™¼ìª½: 3D ë·°ì–´ & ë‚ ì”¨ --><div id="v1.0.0-canvas-container" class="lg:w-1/2 w-full h-1/2 lg:h-full relative bg-black transition-all duration-300">
                    <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm p-4 rounded-lg shadow-xl z-20 grid grid-cols-2 gap-x-6 gap-y-2">
                        <div><h2 class="text-sm font-semibold text-blue-300 uppercase">CUBE-KRW</h2><div id="v1.0.0-current-cube-price" class="text-2xl font-bold text-white">- KRW</div><div id="v1.0.0-cube-price-change" class="text-md font-medium text-gray-300">-</div></div>
                        <div><h2 class="text-sm font-semibold text-purple-300 uppercase">LUNAR-KRW</h2><div id="v1.0.0-current-lunar-price" class="text-2xl font-bold text-white">- KRW</div><div id="v1.0.0-lunar-price-change" class="text-md font-medium text-gray-300">-</div></div>
                        <div><h2 class="text-sm font-semibold text-yellow-300 uppercase">ENERGY-KRW</h2><div id="v1.0.0-current-energy-price" class="text-2xl font-bold text-white">- KRW</div><div id="v1.0.0-energy-price-change" class="text-md font-medium text-gray-300">-</div></div>
                        <div><h2 class="text-sm font-semibold text-pink-300 uppercase">PRISM-KRW</h2><div id="v1.0.0-current-prism-price" class="text-2xl font-bold text-white">- KRW</div><div id="v1.0.0-prism-price-change" class="text-md font-medium text-gray-300">-</div></div>
                        <div id="v1.0.0-time-container" class="hidden mt-2 col-span-1"><h2 class="text-sm font-semibold text-gray-300 uppercase">GAME TIME</h2><div id="v1.0.0-game-time" class="text-xl font-bold text-white">09:00 â˜€ï¸</div></div>
                        <div id="v1.0.0-weather-container" class="hidden mt-2 col-span-1"><h2 class="text-sm font-semibold text-gray-300 uppercase">WEATHER</h2><div id="v1.0.0-weather-display" class="text-xl font-bold text-white">ë§‘ìŒ â˜€ï¸</div></div>
                    </div>
                    <div id="v1.0.0-upgrade-container" class="absolute bottom-4 left-4 flex flex-col md:flex-row gap-4 items-start md:items-end z-20">
                         <div id="v1.0.0-passive-income-display" class="bg-black/50 backdrop-blur-sm p-3 rounded-lg shadow-xl hidden"><h3 class="text-sm font-semibold text-green-300">íŒ¨ì‹œë¸Œ ìˆ˜ì…</h3><div id="v1.0.0-income-per-second" class="text-lg font-bold text-white">+0 KRW / sec</div></div>
                    </div>
                    <div id="v1.0.0-cube-purchase-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-center items-center text-center p-4 z-10">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">3D íë¸Œ ì ê¸ˆ í•´ì œ</h3>
                            <p class="text-gray-300 mb-4">íë¸Œë¥¼ í™œì„±í™”í•˜ê³  ì´ˆë‹¹ 100 KRWë¥¼ ìƒì‚°í•˜ë ¤ë©´ 1,000,000 KRWê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            <button id="v1.0.0-buy-cube-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">1,000,000 KRWì— êµ¬ë§¤</button>
                        </div>
                    </div>
                </div>
                <!-- ì˜¤ë¥¸ìª½: ëŒ€ì‹œë³´ë“œ --><div class="lg:w-1/2 w-full h-1/2 lg:h-full p-6 bg-gray-800 flex flex-col gap-4 overflow-y-auto custom-scrollbar">
                    <h1 class="text-3xl font-bold text-center text-white mb-2">íë¸Œ ì½”ì¸ ì‹œë®¬ë ˆì´í„° <span class="text-lg text-yellow-300">(v.0.4.0 ë‚ ì”¨ ì—…ë°ì´íŠ¸)</span></h1>
                    
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-assets"><h3 class="text-lg font-semibold text-white">ë‚´ ìì‚° í˜„í™©</h3><svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-assets-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v1.0.0-content-assets" class="px-4 pb-4"><div class="grid grid-cols-2 md:grid-cols-3 gap-4"><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">í˜„ê¸ˆ (KRW)</h3><div id="v1.0.0-user-cash" class="text-2xl font-bold text-blue-400">100,000</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">íë¸Œ (CUBE)</h3><div id="v1.0.0-user-cubes" class="text-2xl font-bold text-blue-400">0</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">ë£¨ë‚˜ (LUNAR)</h3><div id="v1.0.0-user-lunar" class="text-2xl font-bold text-purple-400">0</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">ì—ë„ˆì§€ (ENERGY)</h3><div id="v1.0.0-user-energy" class="text-2xl font-bold text-yellow-400">0</div></div><div class="bg-gray-600 p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-300">í”„ë¦¬ì¦˜ (PRISM)</h3><div id="v1.0.0-user-prisms" class="text-2xl font-bold text-pink-400">0</div></div></div></div></div>

                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-computer"><h3 class="text-lg font-semibold text-white">ì±„êµ´ ì»´í“¨í„°</h3><svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-computer-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v1.0.0-content-computer" class="px-4 pb-4"><div id="v1.0.0-computer-info" class="bg-gray-600 p-4 rounded-lg text-center"><p id="v1.0.0-computer-tier-text">ì»´í“¨í„° ì—†ìŒ</p><p id="v1.0.0-computer-stats-text" class="text-xs text-gray-400 mt-1"></p><button id="v1.0.0-computer-upgrade-button" class="mt-4 bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg">êµ¬ë§¤ (Tier 1)</button></div></div></div>
                    
                    <div class="bg-gray-700 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-shop">
                            <h3 class="text-lg font-semibold text-white">ìƒì </h3>
                            <svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-shop-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v1.0.0-content-shop" class="px-4 pb-4 hidden">
                            <div id="v1.0.0-shop-items" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>

                    <div id="v1.0.0-sleep-section" class="bg-gray-700 rounded-lg shadow-lg hidden">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-sleep">
                            <h3 class="text-lg font-semibold text-white">ìˆ˜ë©´</h3>
                            <svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-sleep-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v1.0.0-content-sleep" class="px-4 pb-4 hidden">
                            <div class="flex items-center gap-4">
                                <p class="text-gray-300 text-sm flex-grow">ë°¤ì— ì ì„ ìì„œ ì•„ì¹¨ 8ì‹œê¹Œì§€ ì‹œê°„ì„ ê±´ë„ˆëœë‹ˆë‹¤.</p>
                                <button id="v1.0.0-sleep-button" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg btn-disabled">ìˆ˜ë©´</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="v1.0.0-almanac-section" class="bg-gray-700 rounded-lg shadow-lg hidden">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-almanac">
                            <h3 class="text-lg font-semibold text-white">ë‚ ì”¨ ë„ê°</h3>
                            <svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-almanac-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v1.0.0-content-almanac" class="px-4 pb-4 hidden">
                            <div id="v1.0.0-almanac-content" class="space-y-3">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>
                                    
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-trade"><h3 class="text-lg font-semibold text-white">ì½”ì¸ ê±°ë˜</h3><svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-trade-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v1.0.0-content-trade" class="px-4 pb-4"><div id="v1.0.0-trade-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div></div>
                    
                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-charts"><h3 class="text-lg font-semibold text-white">ì‹¤ì‹œê°„ ì°¨íŠ¸</h3><svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-charts-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v1.0.0-content-charts" class="px-4 pb-4"><nav class="flex border-b border-gray-600 mb-4"><button id="v1.0.0-chart-tab-cube" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">CUBE</button><button id="v1.0.0-chart-tab-lunar" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">LUNAR</button><button id="v1.0.0-chart-tab-energy" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white tab-active">ENERGY</button><button id="v1.0.0-chart-tab-prism" class="py-2 px-4 border-b-2 border-transparent text-gray-400 hover:text-white">PRISM</button></nav><div id="v1.0.0-chart-cube-container" class="h-40 hidden"><canvas id="v1.0.0-price-chart-cube"></canvas></div><div id="v1.0.0-chart-lunar-container" class="h-40 hidden"><canvas id="v1.0.0-price-chart-lunar"></canvas></div><div id="v1.0.0-chart-energy-container" class="h-40"><canvas id="v1.0.0-price-chart-energy"></canvas></div><div id="v1.0.0-chart-prism-container" class="h-40 hidden"><canvas id="v1.0.0-price-chart-prism"></canvas></div></div></div>

                    <div class="bg-gray-700 rounded-lg shadow-lg"><div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-code"><h3 class="text-lg font-semibold text-white">ì½”ë“œ ì…ë ¥</h3><svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-code-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div id="v1.0.0-content-code" class="px-4 pb-4"><div class="flex gap-4"><input type="text" id="v1.0.0-code-input" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì½”ë“œ ì…ë ¥"><button id="v1.0.0-code-submit-button" class="bg-purple-600 hover:bg-purple-700 font-bold py-2 px-6 rounded-lg">ì…ë ¥</button></div></div></div>
                    
                    <div class="bg-gray-700 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center p-4 cursor-pointer" id="v1.0.0-toggle-settings">
                            <h3 class="text-lg font-semibold text-white">ì„¤ì •</h3>
                            <svg class="w-5 h-5 text-gray-400" id="v1.0.0-toggle-settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="v1.0.0-content-settings" class="px-4 pb-4 hidden">
                            <button id="v1.0.0-logout-button" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="v1.0.0-notification" class="fixed bottom-6 right-6 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50"></div>
            <div id="v1.0.0-internet-outage" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center z-50 text-center"><h2 class="text-4xl font-bold text-red-500">ì¸í„°ë„· ì—°ê²° ëŠê¹€ (ë‚ ì”¨ ì˜í–¥)</h2></div>
        </div>
    </main>

    <div id="preview-timer-banner" class="hidden fixed bottom-4 right-4 bg-purple-600 text-white p-3 rounded-lg shadow-xl z-50 font-mono">
        v.0.4.0 í”„ë¦¬ë·° ë‚¨ì€ ì‹œê°„: <span id="preview-timer">05:00</span>
    </div>

    <!-- Firebase SDK (Software Development Kit) -->
    <!-- v8.10.1 is used as it's a stable version compatible with the web API used in the tutorial -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
      // Firebase ì•± êµ¬ì„±
      const firebaseConfig = {
        apiKey: "AIzaSyAMkZ-JoMxZEc2mXbIlZfhf_bVr-wLSHjo",
        authDomain: "cube-coin-simulator.firebaseapp.com",
        projectId: "cube-coin-simulator",
        storageBucket: "cube-coin-simulator.appspot.com",
        messagingSenderId: "734525632764",
        appId: "1:734525632764:web:ba9263fefeeca5726b6779",
        measurementId: "G-LD98Y6BZ3H"
      };
      
      // Firebase ì´ˆê¸°í™”
      if (firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
    </script>

    <script>
        // --- Firebase Instances ---
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ì „ì—­ ì„¤ì • ---
        const V0_4_0_RELEASE_DATE = new Date('2025-11-19T18:00:00');
        const TROPHIES = { twilight: { name: 'Twilight Trophy', description: 'ë°¤í•˜ëŠ˜ì—ì„œ ë°˜ì§ì´ëŠ” ë³„ì„ ì†ì— ë„£ì€ ìì—ê²Œ ì£¼ì–´ì§€ëŠ” ì¦í‘œ.', isUnlocked: () => gameState.shared.hasTwilightTrophy, effectText: 'ë°¤ ì‹œê°„ ë™ì•ˆ ëª¨ë“  ì½”ì¸ ê°€ê²© ìƒìŠ¹ í™•ë¥  +2.5%', } };
        const WEATHER_DATA = {
            'ë§‘ìŒ': { icon: 'â˜€ï¸', description: 'ëª¨ë“  ì½”ì¸: ìƒìŠ¹ í™•ë¥  +0.5%' },
            'ë¹„': { icon: 'ğŸŒ§ï¸', description: 'CUBE: ìƒìŠ¹ í™•ë¥  +2.5%. ë³€ë™ ì£¼ê¸° +5%.' },
            'êµ¬ë¦„': { icon: 'â˜ï¸', description: 'ëª¨ë“  ì½”ì¸: ë³€ë™ ì£¼ê¸° -5%.' },
            'ì‚°ì„±ë¹„': { icon: 'â˜£ï¸', description: 'ëª¨ë“  ì½”ì¸: ìƒìŠ¹ í™•ë¥  -2.5%' },
            'ì²œë‘¥': { icon: 'â›ˆï¸', description: 'ëª¨ë“  ì½”ì¸: ìƒìŠ¹ í™•ë¥  -0.5%. 0.5% í™•ë¥ ë¡œ ì¸í„°ë„· ì—°ê²° ëŠê¹€/ì´ˆ.' },
            'ë¬´ì§€ê°œ': { icon: 'ğŸŒˆ', description: 'ëª¨ë“  ì½”ì¸: ìƒìŠ¹ í™•ë¥  +5%.' }
        };


        let currentVersion;
        let v0_3_0_gameLoopTimeout = null, v0_3_0_priceUpdateTimeout = null, v1_0_0_gameLoopInterval = null, v1_0_0_priceUpdateTimeout = null;
        let v0_3_0_zeroCooldownEndTime = 0, v0_3_0_starCatchingBuffEndTime = 0, v0_3_0_gameTime;
        let v0_3_0_dom = {}, v1_0_0_dom = {}, shared_dom = {}, auth_dom = {};
        let currentUser = null;
        let previewTimerInterval = null;


        // --- 3D ë Œë”ë§ ê´€ë ¨ ---
        let scene, camera, renderer, cube, cubeMaterial, ambientLight, directionalLight;
        let v0_3_0_priceChart, v0_3_0_prismPriceChart, v0_3_0_lunarPriceChart;
        let v1_0_0_chartCube, v1_0_0_chartLunar, v1_0_0_chartEnergy, v1_0_0_chartPrism;

        // --- ê²Œì„ ìƒíƒœ ê´€ë¦¬ ---
        // ëª¨ë“  ê²Œì„ ë°ì´í„°ë¥¼ í¬í•¨í•˜ëŠ” ë‹¨ì¼ ê°ì²´.
        let gameState;

        const getInitialGameState = () => ({
            v0_3_0: {
                userCash: 100000, userCubes: 0, userPrisms: 0, userLunar: 0,
                currentPrice: 10000, lastPrice: 10000, currentPrismPrice: 50000, lastPrismPrice: 50000,
                currentLunarPrice: 20000, lastLunarPrice: 20000, transactions: [],
                isCubePurchased: false, isPrismUpgraded: false, isLunarBlessed: false,
                gameTime: new Date(2025, 10, 15, 9, 0, 0).getTime(), paperClicks: 0,
                jobTimers: { paper: 0, starcatching: 0 },
                isSleeping: false,
            },
            v1_0_0: {
                userEnergy: 0, userPrisms: 0,
                currentPrice: 10000, lastPrice: 10000,
                currentLunarPrice: 20000, lastLunarPrice: 20000,
                currentEnergyPrice: 50000, lastEnergyPrice: 50000,
                currentPrismPrice: 100000, lastPrismPrice: 100000,
                computerTier: 0,
                isCubePurchased: false, isLunarUpgraded: false, isEnergyUpgraded: false, isPrismUpgraded: false,
                weather: 'ë§‘ìŒ', weatherCounter: 0,
                experiencedWeathers: {},
                shopItems: { digitalClock: false, weatherAlmanac: false, bed: false },
                isInternetOutage: false,
                nextWeatherIsRainbow: false,
                lastWeather: 'ë§‘ìŒ',
            },
            shared: {
                hasTwilightTrophy: false,
                usedCodes: [],
                prismMigratedToEnergy: false,
                lastOnlineTimestamp: null,
                v0_4_0_preview_used: false,
                v0_4_0_preview_end_time: 0,
            }
        });

        gameState = getInitialGameState();


        // =======================================================
        // V0.3.0 ê²Œì„ ë¡œì§
        // =======================================================
        function initV0_3_0_Charts() { const commonOptions = { scales: { y: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }; if (document.getElementById('v0.3.0-price-chart')) { const ctxCube = document.getElementById('v0.3.0-price-chart').getContext('2d'); v0_3_0_priceChart = new Chart(ctxCube, { type: 'line', data: { labels: [], datasets: [{ label: 'CUBE Price', data: [], borderColor: '#60a5fa', tension: 0.1, pointRadius: 0 }] }, options: commonOptions }); } if (document.getElementById('v0.3.0-prism-price-chart')) { const ctxPrism = document.getElementById('v0.3.0-prism-price-chart').getContext('2d'); v0_3_0_prismPriceChart = new Chart(ctxPrism, { type: 'line', data: { labels: [], datasets: [{ label: 'PRISM Price', data: [], borderColor: '#f472b6', tension: 0.1, pointRadius: 0 }] }, options: commonOptions }); } if (document.getElementById('v0.3.0-lunar-price-chart')) { const ctxLunar = document.getElementById('v0.3.0-lunar-price-chart').getContext('2d'); v0_3_0_lunarPriceChart = new Chart(ctxLunar, { type: 'line', data: { labels: [], datasets: [{ label: 'LUNAR Price', data: [], borderColor: '#a855f7', tension: 0.1, pointRadius: 0 }] }, options: commonOptions }); } }
        function v0_3_0_updateChartData(chart, price) { if (!chart) return; const now = new Date(v0_3_0_gameTime); const label = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; chart.data.labels.push(label); chart.data.datasets[0].data.push(price); const maxDataPoints = 30; if (chart.data.labels.length > maxDataPoints) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); } chart.update('none'); }

        function initV0_3_0_Game() {
            const prefix = 'v0.3.0-';
            v0_3_0_dom = {
                canvasContainer: document.getElementById(prefix+'canvas-container'), cashDisplay: document.getElementById(prefix+'user-cash'), cubesDisplay: document.getElementById(prefix+'user-cubes'), prismsDisplay: document.getElementById(prefix+'user-prisms'), priceDisplay: document.getElementById(prefix+'current-price'), priceChangeDisplay: document.getElementById(prefix+'price-change'), prismPriceDisplay: document.getElementById(prefix+'current-prism-price'), prismPriceChangeDisplay: document.getElementById(prefix+'prism-price-change'), buyButtonCube: document.getElementById(prefix+'buy-button-cube'), sellButtonCube: document.getElementById(prefix+'sell-button-cube'), buyButtonPrism: document.getElementById(prefix+'buy-button-prism'), sellButtonPrism: document.getElementById(prefix+'sell-button-prism'), notification: document.getElementById(prefix+'notification'), buyCubeButton: document.getElementById(prefix+'buy-cube-button'), cubeOverlay: document.getElementById(prefix+'cube-purchase-overlay'), upgradePrismSection: document.getElementById(prefix+'upgrade-prism-section'), upgradePrismButton: document.getElementById(prefix+'upgrade-prism-button'), jobPaper: document.getElementById(prefix+'job-paper'), jobPaperTimer: document.getElementById(prefix+'job-paper-timer'), jobPaperText: document.getElementById(prefix+'job-paper-text'), codeSubmitButton: document.getElementById(prefix+'code-submit-button'), passiveIncomeDisplay: document.getElementById(prefix+'passive-income-display'), incomePerSecond: document.getElementById(prefix+'income-per-second'), chartTabCube: document.getElementById(prefix+'chart-tab-cube'), chartTabPrism: document.getElementById(prefix+'chart-tab-prism'), chartCubeContainer: document.getElementById(prefix+'chart-cube-container'), chartPrismContainer: document.getElementById(prefix+'chart-prism-container'), transactionHistory: document.getElementById(prefix+'transaction-history'), newsFeed: document.getElementById(prefix+'news-feed'), codeInput: document.getElementById(prefix+'code-input'), amountInputCube: document.getElementById(prefix+'amount-input-cube'), amountInputPrism: document.getElementById(prefix+'amount-input-prism'),
                userLunar: document.getElementById(prefix+'user-lunar'), currentLunarPrice: document.getElementById(prefix+'current-lunar-price'), lunarPriceChange: document.getElementById(prefix+'lunar-price-change'), lunarPriceDisplay: document.getElementById(prefix+'lunar-price-display'), lunarAssetDisplay: document.getElementById(prefix+'lunar-asset-display'), buyButtonLunar: document.getElementById(prefix+'buy-button-lunar'), sellButtonLunar: document.getElementById(prefix+'sell-button-lunar'), amountInputLunar: document.getElementById(prefix+'amount-input-lunar'), gameTime: document.getElementById(prefix+'game-time'), timeContainer: document.getElementById(prefix+'time-container'), jobStarcatching: document.getElementById(prefix+'job-starcatching'), jobStarcatchingTimer: document.getElementById(prefix+'job-starcatching-timer'), sleepButton: document.getElementById(prefix+'sleep-button'), sleepSection: document.getElementById(prefix+'sleep-section'), upgradeLunarSection: document.getElementById(prefix+'upgrade-lunar-section'), upgradeLunarBlessingButton: document.getElementById(prefix+'upgrade-lunar-blessing-button'), chartTabLunar: document.getElementById(prefix+'chart-tab-lunar'), chartLunarContainer: document.getElementById(prefix+'chart-lunar-container'), lunarTradeSection: document.getElementById(prefix+'lunar-trade-section'), gameTitle: document.getElementById(prefix+'game-title'), versionDisplay: document.getElementById(prefix+'version-display'), updateList: document.getElementById(prefix+'update-list'),
                trophyList: document.getElementById(prefix+'trophy-list'), trophyEffects: document.getElementById(prefix+'trophy-effects'),
                logoutButton: document.getElementById(prefix + 'logout-button'),
            };
            if (v0_3_0_dom.buyButtonCube) v0_3_0_dom.buyButtonCube.addEventListener('click', () => v0_3_0_handleTrade('buy', 'cube')); 
            if (v0_3_0_dom.sellButtonCube) v0_3_0_dom.sellButtonCube.addEventListener('click', () => v0_3_0_handleTrade('sell', 'cube')); 
            if (v0_3_0_dom.buyButtonPrism) v0_3_0_dom.buyButtonPrism.addEventListener('click', () => v0_3_0_handleTrade('buy', 'prism')); 
            if (v0_3_0_dom.sellButtonPrism) v0_3_0_dom.sellButtonPrism.addEventListener('click', () => v0_3_0_handleTrade('sell', 'prism')); 
            if (v0_3_0_dom.buyCubeButton) v0_3_0_dom.buyCubeButton.addEventListener('click', v0_3_0_handleBuy3DCube); 
            if (v0_3_0_dom.upgradePrismButton) v0_3_0_dom.upgradePrismButton.addEventListener('click', v0_3_0_handleUpgradePrism); 
            if (v0_3_0_dom.jobPaper) v0_3_0_dom.jobPaper.addEventListener('click', v0_3_0_handleJobClick); 
            if (v0_3_0_dom.codeSubmitButton) v0_3_0_dom.codeSubmitButton.addEventListener('click', handleCodeSubmit); 
            if (v0_3_0_dom.chartTabCube) v0_3_0_dom.chartTabCube.addEventListener('click', () => v0_3_0_switchChart('cube')); 
            if (v0_3_0_dom.chartTabPrism) v0_3_0_dom.chartTabPrism.addEventListener('click', () => v0_3_0_switchChart('prism')); 
            ['assets', 'trade', 'charts', 'history', 'news', 'jobs', 'trophies', 'code', 'updates', 'sleep', 'settings'].forEach(s => document.getElementById(`${prefix}toggle-${s}`)?.addEventListener('click', () => { document.getElementById(`${prefix}content-${s}`).classList.toggle('hidden'); document.getElementById(`${prefix}toggle-${s}-icon`).classList.toggle('rotate-180'); })); 
            
            if (v0_3_0_dom.gameTitle) v0_3_0_dom.gameTitle.textContent = 'íë¸Œ ì½”ì¸ ì‹œë®¬ë ˆì´í„°';
            if (v0_3_0_dom.versionDisplay) v0_3_0_dom.versionDisplay.textContent = '(v.0.3.0)';
            if (v0_3_0_dom.updateList) v0_3_0_dom.updateList.innerHTML = '<li>v.0.3.0 ë‹¬ë¹› ì—…ë°ì´íŠ¸ ì ìš©</li><li>ë‚®ê³¼ ë°¤ ì‹œìŠ¤í…œ ì¶”ê°€</li><li>ì‹ ê·œ ì½”ì¸ $LUNAR ë° ë‹¬ë¹› ì´ë²¤íŠ¸ ì¶”ê°€</li><li>ìˆ˜ë©´ ì‹œìŠ¤í…œ ì¶”ê°€</li><li>\'íì§€ ì¤ê¸°\' ë¡œì§ ì•ˆì •í™”</li>';
            
            if (v0_3_0_dom.buyButtonLunar) v0_3_0_dom.buyButtonLunar.addEventListener('click', () => v0_3_0_handleTrade('buy', 'lunar')); 
            if (v0_3_0_dom.sellButtonLunar) v0_3_0_dom.sellButtonLunar.addEventListener('click', () => v0_3_0_handleTrade('sell', 'lunar'));
            if (v0_3_0_dom.jobStarcatching) v0_3_0_dom.jobStarcatching.addEventListener('click', v0_3_0_handleJobClick);
            if (v0_3_0_dom.chartTabLunar) v0_3_0_dom.chartTabLunar.addEventListener('click', () => v0_3_0_switchChart('lunar'));
            if (v0_3_0_dom.upgradeLunarBlessingButton) v0_3_0_dom.upgradeLunarBlessingButton.addEventListener('click', v0_3_0_handleUpgradeLunarBlessing);
            if (v0_3_0_dom.sleepButton) v0_3_0_dom.sleepButton.addEventListener('click', v0_3_0_handleSleep);
            if (v0_3_0_dom.logoutButton) v0_3_0_dom.logoutButton.addEventListener('click', handleLogout);
            
            initV0_3_0_Charts();
        }
        function v0_3_0_startGame() {
            if (v0_3_0_gameLoopTimeout) clearTimeout(v0_3_0_gameLoopTimeout);
            if (v0_3_0_priceUpdateTimeout) clearTimeout(v0_3_0_priceUpdateTimeout);
            v0_3_0_gameTime = new Date(gameState.v0_3_0.gameTime);
            v0_3_0_restoreUIState();
            v0_3_0_gameLoop();
            v0_3_0_priceUpdateLoop();
        }

        function v0_3_0_showNotification(message, isError = true) { if(!v0_3_0_dom.notification) return; v0_3_0_dom.notification.textContent = message; v0_3_0_dom.notification.className = `fixed bottom-6 right-6 text-white p-4 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0 transition-all duration-300`; setTimeout(() => { v0_3_0_dom.notification.classList.add('opacity-0', 'translate-y-10'); }, 3000); }

        function v0_3_0_updateTrophyDisplay() {
            if (!v0_3_0_dom.trophyList || !v0_3_0_dom.trophyEffects) return;
            v0_3_0_dom.trophyList.innerHTML = '';
            let totalEffectsHTML = ''; let hasEffects = false;
            for (const key in TROPHIES) {
                const trophy = TROPHIES[key]; const isUnlocked = trophy.isUnlocked();
                const trophyEl = document.createElement('div');
                trophyEl.className = `bg-gray-600 p-3 rounded-lg flex items-center gap-4 transition-opacity ${isUnlocked ? '' : 'opacity-50'}`;
                trophyEl.innerHTML = `<div><span class="font-bold text-lg ${isUnlocked ? 'text-yellow-400' : 'text-gray-400'}">${isUnlocked ? 'ğŸ†' : 'ğŸ”’'} ${trophy.name}</span><p class="text-xs text-gray-400 mt-1">${trophy.description}</p></div>`;
                v0_3_0_dom.trophyList.appendChild(trophyEl);
                if (isUnlocked) { totalEffectsHTML += `<p>â€¢ ${trophy.effectText}</p>`; hasEffects = true; }
            }
            if (hasEffects) { v0_3_0_dom.trophyEffects.innerHTML = totalEffectsHTML; } else { v0_3_0_dom.trophyEffects.innerHTML = '<p class="text-gray-500">í™œì„±í™”ëœ íš¨ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; }
        }

        function v0_3_0_updateUI() {
            if (!v0_3_0_dom.cashDisplay) return;
            const state = gameState.v0_3_0;
            v0_3_0_dom.cashDisplay.textContent = Math.floor(state.userCash).toLocaleString('ko-KR');
            v0_3_0_dom.cubesDisplay.textContent = state.userCubes.toLocaleString('ko-KR', { maximumFractionDigits: 4 });
            v0_3_0_dom.prismsDisplay.textContent = state.userPrisms.toLocaleString('ko-KR');
            
            const updatePriceDisplay = (display, changeDisplay, current, last) => {
                if (!display || !changeDisplay) return;
                display.textContent = `${current.toLocaleString('ko-KR')} KRW`;
                const change = current - last; const pct = last > 0 ? ((change / last) * 100).toFixed(2) : 0;
                if (change > 0) changeDisplay.innerHTML = `<span class="text-green-500">â–² ${change.toLocaleString('ko-KR')} (+${pct}%)</span>`;
                else if (change < 0) changeDisplay.innerHTML = `<span class="text-red-500">â–¼ ${Math.abs(change).toLocaleString('ko-KR')} (${pct}%)</span>`;
                else changeDisplay.innerHTML = `0 (0.00%)`;
            };
            updatePriceDisplay(v0_3_0_dom.priceDisplay, v0_3_0_dom.priceChangeDisplay, state.currentPrice, state.lastPrice);
            updatePriceDisplay(v0_3_0_dom.prismPriceDisplay, v0_3_0_dom.prismPriceChangeDisplay, state.currentPrismPrice, state.lastPrismPrice);
            
            const isDay = v0_3_0_gameTime.getHours() >= 9 && v0_3_0_gameTime.getHours() < 19;
            let lunarIncome = (state.isLunarBlessed && !isDay) ? 100 : 0;
            if (v0_3_0_dom.userLunar) v0_3_0_dom.userLunar.textContent = state.userLunar.toLocaleString('ko-KR');
            updatePriceDisplay(v0_3_0_dom.currentLunarPrice, v0_3_0_dom.lunarPriceChange, state.currentLunarPrice, state.lastLunarPrice);
            const gameHours = v0_3_0_gameTime.getHours(), gameMinutes = String(v0_3_0_gameTime.getMinutes()).padStart(2, '0');
            if (v0_3_0_dom.gameTime) v0_3_0_dom.gameTime.textContent = `${String(gameHours).padStart(2, '0')}:${gameMinutes} (${isDay ? 'â˜€ï¸' : 'ğŸŒ™'})`;
            
            const totalIncome = (state.isCubePurchased ? 100 : 0) + (state.isPrismUpgraded ? 900 : 0) + lunarIncome;
            if (v0_3_0_dom.incomePerSecond) v0_3_0_dom.incomePerSecond.textContent = `+${totalIncome.toLocaleString('ko-KR')} KRW / sec`;
            
            v0_3_0_updateTransactionHistory();
            v0_3_0_updateTrophyDisplay();
        }

        function v0_3_0_updateTransactionHistory() { if (!v0_3_0_dom.transactionHistory) return; const transactions = gameState.v0_3_0.transactions; if (transactions.length === 0) { v0_3_0_dom.transactionHistory.innerHTML = '<div class="text-gray-400 text-sm text-center p-4">...</div>'; return; } v0_3_0_dom.transactionHistory.innerHTML = ''; transactions.slice(-100).forEach(tx => { const el = document.createElement('div'); el.className = 'border-b border-gray-600 p-2 text-sm'; const typeClass = tx.type === 'ë§¤ìˆ˜' ? 'text-green-400' : 'text-red-400'; el.innerHTML = `<div><span class="${typeClass} font-bold">[${tx.type}]</span> ${tx.amount.toLocaleString('ko-KR')} ${tx.coin}</div><div class="text-xs text-gray-400">@ ${tx.price.toLocaleString('ko-KR')} KRW</div>`; v0_3_0_dom.transactionHistory.prepend(el); }); }
        function v0_3_0_getNewPrice(currentPrice, config) {
            const isDay = v0_3_0_gameTime.getHours() >= 9 && v0_3_0_gameTime.getHours() < 19;
            let trophyBonus = !isDay && gameState.shared.hasTwilightTrophy ? 0.025 : 0;
            let dir = Math.random() < (config.riseProb + trophyBonus) ? 1 : -1;
            let mag = Math.random(), pct;
            if (mag < config.mags[0]) pct = (Math.random() * 0.02) + 0.001;
            else if (mag < config.mags[0] + config.mags[1]) pct = (Math.random() * 0.05) + 0.021;
            else pct = (Math.random() * 0.12) + 0.051;
            const newPrice = currentPrice + (currentPrice * pct * dir);
            return Math.round(Math.max(config.min, Math.min(config.max, newPrice)));
        }

        function v0_3_0_priceUpdateLoop() {
            if (gameState.v0_3_0.isSleeping) {
                v0_3_0_priceUpdateTimeout = setTimeout(v0_3_0_priceUpdateLoop, 2000);
                return;
            }
            const state = gameState.v0_3_0;
            const isDay = v0_3_0_gameTime.getHours() >= 9 && v0_3_0_gameTime.getHours() < 19;
            const getFullConfig = (coinConfig, mode) => ({ min: coinConfig.min, max: coinConfig.max, ...coinConfig[mode] });
            const configs = { 
                cube: { min: 5000, max: 25000, day: { riseProb: 0.51, mags: [0.5, 0.45, 0.05] }, night: { riseProb: 0.51, mags: [0.6, 0.4, 0] } }, 
                prism: { min: 40000, max: 200000, day: { riseProb: 0.53, mags: [0.5, 0.45, 0.05] }, night: { riseProb: 0.53, mags: [0.6, 0.4, 0] } }, 
                lunar: { min: 10000, max: 50000, day: { riseProb: 0.45, mags: [0.5, 0.45, 0.05] }, night: { riseProb: 0.55, mags: [0.4, 0.5, 0.1] } } 
            };
            const updatePrices = (mode) => {
                state.lastPrice = state.currentPrice; state.currentPrice = v0_3_0_getNewPrice(state.currentPrice, getFullConfig(configs.cube, mode)); v0_3_0_updateChartData(v0_3_0_priceChart, state.currentPrice);
                state.lastPrismPrice = state.currentPrismPrice; state.currentPrismPrice = v0_3_0_getNewPrice(state.currentPrismPrice, getFullConfig(configs.prism, mode)); v0_3_0_updateChartData(v0_3_0_prismPriceChart, state.currentPrismPrice);
                state.lastLunarPrice = state.currentLunarPrice; state.currentLunarPrice = v0_3_0_getNewPrice(state.currentLunarPrice, getFullConfig(configs.lunar, mode)); v0_3_0_updateChartData(v0_3_0_lunarPriceChart, state.currentLunarPrice);
            };
            updatePrices(isDay ? 'day' : 'night');
            const interval = isDay ? 2000 : 4000; 
            v0_3_0_priceUpdateTimeout = setTimeout(v0_3_0_priceUpdateLoop, interval);
        }

        function v0_3_0_gameLoop() {
            const now = Date.now();
            const state = gameState.v0_3_0;
            const isZeroCooldown = v0_3_0_zeroCooldownEndTime > now;

            if (!state.isSleeping) {
                v0_3_0_gameTime.setMinutes(v0_3_0_gameTime.getMinutes() + 1);
                const lunarIncome = (state.isLunarBlessed && !(v0_3_0_gameTime.getHours() >= 9 && v0_3_0_gameTime.getHours() < 19)) ? 100 : 0;
                state.userCash += ((state.isCubePurchased ? 100 : 0) + (state.isPrismUpgraded ? 900 : 0) + lunarIncome) / 4;
            }
            
            const currentHour = v0_3_0_gameTime.getHours();
            const isDay = currentHour >= 9 && currentHour < 19;
            if (v0_3_0_dom.canvasContainer && (v0_3_0_dom.canvasContainer.style.backgroundColor === 'rgb(5, 5, 34)') !== !isDay) { // Day/Night transition
                const color = isDay ? 0x222222 : 0x050522;
                if(renderer) renderer.setClearColor(color);
                if(ambientLight) ambientLight.intensity = isDay ? 0.7 : 0.5;
                if(directionalLight) directionalLight.intensity = isDay ? 1.0 : 0.6;
            }
            
            if (v0_3_0_dom.jobStarcatching) v0_3_0_dom.jobStarcatching.classList.toggle('hidden', isDay || gameState.shared.hasTwilightTrophy);
            if (v0_3_0_dom.sleepButton) v0_3_0_dom.sleepButton.classList.toggle('btn-disabled', !(currentHour >= 20 || currentHour < 8));
            if (v0_3_0_dom.jobPaperText) { v0_3_0_dom.jobPaperText.textContent = (gameState.shared.hasTwilightTrophy && !isDay) ? 'ë‹¬ë¹› ì•„ë˜ íì§€ ì¤ê¸° (+1500)' : 'íì§€ ì¤ê¸° (+500)'; }
            
            Object.keys(state.jobTimers).forEach(job => {
                const timerEl = v0_3_0_dom[`job${job}Timer`], jobEl = v0_3_0_dom[`job${job}`];
                if (isZeroCooldown) { if (jobEl) jobEl.classList.remove('btn-disabled'); if (timerEl) timerEl.textContent = '(0ì´ˆ)'; } 
                else { if (state.jobTimers[job] > now) { const timeLeft = Math.ceil((state.jobTimers[job] - now) / 1000); if (timerEl) timerEl.textContent = `(${timeLeft}ì´ˆ)`; if(jobEl) jobEl.classList.add('btn-disabled'); } else if(jobEl) { jobEl.classList.remove('btn-disabled'); if (timerEl) timerEl.textContent = ''; } }
            });
            v0_3_0_updateUI();
            v0_3_0_gameLoopTimeout = setTimeout(v0_3_0_gameLoop, 250);
        }
        function v0_3_0_handleTrade(type, coin) {
            const state = gameState.v0_3_0;
            const amountInput = v0_3_0_dom[`amountInput${coin.charAt(0).toUpperCase() + coin.slice(1)}`];
            if (!amountInput) return; const amount = parseInt(amountInput.value); if (!(amount > 0)) return;
            const prices = { cube: state.currentPrice, prism: state.currentPrismPrice, lunar: state.currentLunarPrice };
            const cost = prices[coin] * amount, coinUpper = coin.toUpperCase();

            if (type === 'buy') {
                if (state.userCash >= cost) { state.userCash -= cost; if(coin === 'cube') state.userCubes += amount; else if (coin === 'prism') state.userPrisms += amount; else state.userLunar += amount; state.transactions.push({ type: 'ë§¤ìˆ˜', coin: coinUpper, amount, price: prices[coin] }); v0_3_0_showNotification(`${amount} ${coinUpper} ë§¤ìˆ˜!`, false); } 
                else { v0_3_0_showNotification('í˜„ê¸ˆ ë¶€ì¡±', true); return; }
            } else { if ((coin === 'cube' && state.userCubes >= amount) || (coin === 'prism' && state.userPrisms >= amount) || (coin === 'lunar' && state.userLunar >= amount)) { state.userCash += cost; if(coin === 'cube') state.userCubes -= amount; else if (coin === 'prism') state.userPrisms -= amount; else state.userLunar -= amount; state.transactions.push({ type: 'ë§¤ë„', coin: coinUpper, amount, price: prices[coin] }); v0_3_0_showNotification(`${amount} ${coinUpper} ë§¤ë„!`, false); } 
                else { v0_3_0_showNotification(`${coinUpper} ë¶€ì¡±`, true); return; }
            }
            v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e));
        }
        function v0_3_0_handleJobClick(e) {
            const id = e.currentTarget.id.split('-')[2], now = Date.now(), state = gameState.v0_3_0;
            const isZeroCooldown = v0_3_0_zeroCooldownEndTime > now;
            if (!isZeroCooldown && state.jobTimers[id] > now) { v0_3_0_showNotification('ì•„ì§ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤.', true); return; }
            const isDay = v0_3_0_gameTime.getHours() >= 9 && v0_3_0_gameTime.getHours() < 19;

            if (id === 'paper') { 
                const isEnhanced = gameState.shared.hasTwilightTrophy && !isDay;
                const reward = isEnhanced ? 1500 : 500, message = isEnhanced ? 'ë‹¬ë¹›ì„ ë°›ìœ¼ë©° íì§€ ì¤ê¸° ì™„ë£Œ! (+1500 KRW)' : 'íì§€ ì¤ê¸° ì™„ë£Œ! (+500 KRW)';
                state.userCash += reward; state.paperClicks++; v0_3_0_showNotification(message, false); if (!isZeroCooldown) state.jobTimers.paper = now + 5000; 
            }
            if (id === 'starcatching') {
                if (gameState.shared.hasTwilightTrophy) { v0_3_0_showNotification('ì´ë¯¸ í™©í˜¼ì˜ íŠ¸ë¡œí”¼ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', true); return; }
                const success = Math.random() < 0.25; 
                if (success) { gameState.shared.hasTwilightTrophy = true; v0_3_0_showNotification('í™©í˜¼ì˜ íŠ¸ë¡œí”¼ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', false); v0_3_0_updateTrophyDisplay(); if (v0_3_0_dom.jobStarcatching) v0_3_0_dom.jobStarcatching.classList.add('hidden'); } 
                else { v0_3_0_showNotification('ë³„ì„ ë†“ì³¤ìŠµë‹ˆë‹¤...', true); }
                if (!isZeroCooldown) state.jobTimers.starcatching = now + 60000;
            }
            v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e));
        }

        function v0_3_0_handleBuy3DCube() { const state = gameState.v0_3_0; if (state.userCash >= 1000000) { state.userCash -= 1000000; state.isCubePurchased = true; v0_3_0_restoreUIState(); v0_3_0_showNotification('3D íë¸Œ êµ¬ë§¤ ì™„ë£Œ!', false); v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e)); } else { v0_3_0_showNotification('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); } }
        function v0_3_0_handleUpgradePrism() { const state = gameState.v0_3_0; if (state.userPrisms >= 100) { state.userPrisms -= 100; state.isPrismUpgraded = true; v0_3_0_restoreUIState(); v0_3_0_showNotification('í”„ë¦¬ì¦˜ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!', false); if (cubeMaterial) cubeMaterial.color.set(0xf472b6); v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e)); } else { v0_3_0_showNotification('í”„ë¦¬ì¦˜ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); } }
        function v0_3_0_handleUpgradeLunarBlessing() { const state = gameState.v0_3_0; if (state.userLunar >= 200) { state.userLunar -= 200; state.isLunarBlessed = true; v0_3_0_restoreUIState(); v0_3_0_showNotification('ë‹¬ë¹› ê°•í™” ì™„ë£Œ!', false); v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e)); } else { v0_3_0_showNotification('ë£¨ë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); } }
        function v0_3_0_handleSleep() { const state = gameState.v0_3_0; if (state.isSleeping) return; state.isSleeping = true; v0_3_0_showNotification('ìˆ˜ë©´ì„ ì‹œì‘í•©ë‹ˆë‹¤...', false); if (v0_3_0_dom.sleepButton) v0_3_0_dom.sleepButton.textContent = 'ìˆ˜ë©´ ì¤‘...'; const hoursToSleep = (32 - v0_3_0_gameTime.getHours()) % 24; const sleepTime = hoursToSleep * 60 * 250; setTimeout(() => { state.isSleeping = false; v0_3_0_gameTime.setHours(8, 0, 0, 0); v0_3_0_showNotification('ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤!', false); if (v0_3_0_dom.sleepButton) v0_3_0_dom.sleepButton.textContent = 'ìˆ˜ë©´'; v0_3_0_updateUI(); saveGameState().catch(e => console.error("Save failed:", e)); }, sleepTime); }
        function v0_3_0_switchChart(chartName) { const charts = ['cube', 'prism', 'lunar']; charts.forEach(c => { v0_3_0_dom[`chart${c.charAt(0).toUpperCase() + c.slice(1)}Container`].classList.toggle('hidden', c !== chartName); v0_3_0_dom[`chartTab${c.charAt(0).toUpperCase() + c.slice(1)}`].classList.toggle('tab-active', c === chartName); }); }
        function v0_3_0_restoreUIState() { const state = gameState.v0_3_0; if (v0_3_0_dom.cubeOverlay) v0_3_0_dom.cubeOverlay.classList.toggle('hidden', state.isCubePurchased); if (v0_3_0_dom.passiveIncomeDisplay) v0_3_0_dom.passiveIncomeDisplay.classList.toggle('hidden', !state.isCubePurchased); if (v0_3_0_dom.upgradePrismSection) v0_3_0_dom.upgradePrismSection.classList.toggle('hidden', !state.isCubePurchased || state.isPrismUpgraded); if (v0_3_0_dom.upgradeLunarSection) v0_3_0_dom.upgradeLunarSection.classList.toggle('hidden', !state.isCubePurchased || state.isLunarBlessed); if (state.isPrismUpgraded && cubeMaterial) cubeMaterial.color.set(0xf472b6); v0_3_0_updateUI(); }

        // =======================================================
        // V1.0.0 (v.0.4.0) ê²Œì„ ë¡œì§
        // =======================================================
        function initV1_0_0_Charts() { const commonOptions = { scales: { y: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }; const createChart = (id, borderColor, label) => { const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return null; return new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label, data: [], borderColor, tension: 0.1, pointRadius: 0 }] }, options: commonOptions }); }; v1_0_0_chartCube = createChart('v1.0.0-price-chart-cube', '#60a5fa', 'CUBE'); v1_0_0_chartLunar = createChart('v1.0.0-price-chart-lunar', '#a855f7', 'LUNAR'); v1_0_0_chartEnergy = createChart('v1.0.0-price-chart-energy', '#facc15', 'ENERGY'); v1_0_0_chartPrism = createChart('v1.0.0-price-chart-prism', '#f472b6', 'PRISM'); }
        function v1_0_0_updateChartData(chart, price, time) { if (!chart) return; const label = time; chart.data.labels.push(label); chart.data.datasets[0].data.push(price); if (chart.data.labels.length > 30) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); } chart.update('none'); }
        function initV1_0_0_Game() {
            const prefix = 'v1.0.0-';
            v1_0_0_dom = {
                canvasContainer: document.getElementById(prefix+'canvas-container'), userCash: document.getElementById(prefix+'user-cash'), userCubes: document.getElementById(prefix+'user-cubes'), userLunar: document.getElementById(prefix+'user-lunar'), userEnergy: document.getElementById(prefix+'user-energy'), userPrisms: document.getElementById(prefix+'user-prisms'),
                currentCubePrice: document.getElementById(prefix+'current-cube-price'), cubePriceChange: document.getElementById(prefix+'cube-price-change'), currentLunarPrice: document.getElementById(prefix+'current-lunar-price'), lunarPriceChange: document.getElementById(prefix+'lunar-price-change'), currentEnergyPrice: document.getElementById(prefix+'current-energy-price'), energyPriceChange: document.getElementById(prefix+'energy-price-change'), currentPrismPrice: document.getElementById(prefix+'current-prism-price'), prismPriceChange: document.getElementById(prefix+'prism-price-change'),
                notification: document.getElementById(prefix+'notification'), internetOutage: document.getElementById(prefix+'internet-outage'),
                buyCubeButton: document.getElementById(prefix+'buy-cube-button'), cubePurchaseOverlay: document.getElementById(prefix+'cube-purchase-overlay'), passiveIncomeDisplay: document.getElementById(prefix+'passive-income-display'), incomePerSecond: document.getElementById(prefix+'income-per-second'),
                computerInfo: document.getElementById(prefix+'computer-info'), computerTierText: document.getElementById(prefix+'computer-tier-text'), computerStatsText: document.getElementById(prefix+'computer-stats-text'), computerUpgradeButton: document.getElementById(prefix+'computer-upgrade-button'),
                tradeContainer: document.getElementById(prefix+'trade-container'),
                chartTabCube: document.getElementById(prefix+'chart-tab-cube'), chartTabLunar: document.getElementById(prefix+'chart-tab-lunar'), chartTabEnergy: document.getElementById(prefix+'chart-tab-energy'), chartTabPrism: document.getElementById(prefix+'chart-tab-prism'),
                chartCubeContainer: document.getElementById(prefix+'chart-cube-container'), chartLunarContainer: document.getElementById(prefix+'chart-lunar-container'), chartEnergyContainer: document.getElementById(prefix+'chart-energy-container'), chartPrismContainer: document.getElementById(prefix+'chart-prism-container'),
                timeContainer: document.getElementById(prefix+'time-container'), gameTime: document.getElementById(prefix+'game-time'), weatherContainer: document.getElementById(prefix+'weather-container'), weatherDisplay: document.getElementById(prefix+'weather-display'),
                shopSection: document.getElementById(prefix+'shop-section'), shopItems: document.getElementById(prefix+'shop-items'),
                almanacSection: document.getElementById(prefix+'almanac-section'), almanacContent: document.getElementById(prefix+'almanac-content'),
                sleepSection: document.getElementById(prefix+'sleep-section'), sleepButton: document.getElementById(prefix+'sleep-button'),
                logoutButton: document.getElementById(prefix+'logout-button'),
                codeSubmitButton: document.getElementById(prefix+'code-submit-button'),
                codeInput: document.getElementById(prefix+'code-input'),
            };
            ['assets', 'computer', 'shop', 'sleep', 'almanac', 'trade', 'charts', 'code', 'settings'].forEach(s => { const toggle = document.getElementById(`${prefix}toggle-${s}`); if (toggle) { toggle.addEventListener('click', () => { document.getElementById(`${prefix}content-${s}`).classList.toggle('hidden'); document.getElementById(`${prefix}toggle-${s}-icon`).classList.toggle('rotate-180'); }); } });
            if (v1_0_0_dom.buyCubeButton) v1_0_0_dom.buyCubeButton.addEventListener('click', v1_0_0_handleBuy3DCube);
            if (v1_0_0_dom.computerUpgradeButton) v1_0_0_dom.computerUpgradeButton.addEventListener('click', v1_0_0_handleComputerUpgrade);
            if (v1_0_0_dom.sleepButton) v1_0_0_dom.sleepButton.addEventListener('click', v1_0_0_handleSleep);
            if (v1_0_0_dom.logoutButton) v1_0_0_dom.logoutButton.addEventListener('click', handleLogout);
            if (v1_0_0_dom.codeSubmitButton) v1_0_0_dom.codeSubmitButton.addEventListener('click', handleCodeSubmit);
            ['cube', 'lunar', 'energy', 'prism'].forEach(c => v1_0_0_dom[`chartTab${c.charAt(0).toUpperCase() + c.slice(1)}`]?.addEventListener('click', () => v1_0_0_switchChart(c)));
            v1_0_0_populateTradeUI();
            v1_0_0_populateShopItems();
            initV1_0_0_Charts();
        }
        function v1_0_0_startGame() { if (v1_0_0_gameLoopInterval) clearInterval(v1_0_0_gameLoopInterval); if (v1_0_0_priceUpdateTimeout) clearTimeout(v1_0_0_priceUpdateTimeout); v1_0_0_migrateData(); v1_0_0_restoreUIState(); v1_0_0_gameLoopInterval = setInterval(v1_0_0_gameLoop, 250); v1_0_0_priceUpdateLoop(); }
        function v1_0_0_migrateData() {
            if (gameState.shared.prismMigratedToEnergy) return;
            gameState.v1_0_0.userCash = gameState.v0_3_0.userCash;
            gameState.v1_0_0.userCubes = gameState.v0_3_0.userCubes;
            gameState.v1_0_0.userLunar = gameState.v0_3_0.userLunar;
            gameState.v1_0_0.userEnergy = gameState.v0_3_0.userPrisms;
            gameState.v1_0_0.isCubePurchased = gameState.v0_3_0.isCubePurchased;
            gameState.v1_0_0.isLunarUpgraded = gameState.v0_3_0.isLunarBlessed;
            gameState.v1_0_0.isEnergyUpgraded = gameState.v0_3_0.isPrismUpgraded;
            gameState.v1_0_0.isPrismUpgraded = false;
            gameState.shared.prismMigratedToEnergy = true;
            saveGameState().catch(e => console.error("Save failed during migration:", e));
            v1_0_0_showNotification('v.0.4.0 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! $PRISMì´ $ENERGYë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
        }
        function v1_0_0_showNotification(message, isError = true) { if (!v1_0_0_dom.notification) return; v1_0_0_dom.notification.textContent = message; v1_0_0_dom.notification.className = `fixed bottom-6 right-6 text-white p-4 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0 transition-all duration-300`; setTimeout(() => v1_0_0_dom.notification.classList.add('opacity-0', 'translate-y-10'); }, 3000); }

        function v1_0_0_updateUI() {
            const state = gameState.v1_0_0;
            if (!v1_0_0_dom.userCash) return;
            v1_0_0_dom.userCash.textContent = Math.floor(state.userCash).toLocaleString('ko-KR');
            v1_0_0_dom.userCubes.textContent = state.userCubes.toLocaleString('ko-KR', { maximumFractionDigits: 4 });
            v1_0_0_dom.userLunar.textContent = state.userLunar.toLocaleString('ko-KR');
            v1_0_0_dom.userEnergy.textContent = state.userEnergy.toLocaleString('ko-KR');
            v1_0_0_dom.userPrisms.textContent = state.userPrisms.toLocaleString('ko-KR');
            const updatePriceDisplay = (priceEl, changeEl, current, last) => { if (!priceEl || !changeEl) return; priceEl.textContent = `${current.toLocaleString('ko-KR')} KRW`; const change = current - last; const pct = last > 0 ? ((change / last) * 100).toFixed(2) : 0; if (change > 0) changeEl.innerHTML = `<span class="text-green-500">â–² ${change.toLocaleString('ko-KR')} (+${pct}%)</span>`; else if (change < 0) changeEl.innerHTML = `<span class="text-red-500">â–¼ ${Math.abs(change).toLocaleString('ko-KR')} (${pct}%)</span>`; else changeEl.innerHTML = `0 (0.00%)`; };
            updatePriceDisplay(v1_0_0_dom.currentCubePrice, v1_0_0_dom.cubePriceChange, state.currentPrice, state.lastPrice);
            updatePriceDisplay(v1_0_0_dom.currentLunarPrice, v1_0_0_dom.lunarPriceChange, state.currentLunarPrice, state.lastLunarPrice);
            updatePriceDisplay(v1_0_0_dom.currentEnergyPrice, v1_0_0_dom.energyPriceChange, state.currentEnergyPrice, state.lastEnergyPrice);
            updatePriceDisplay(v1_0_0_dom.currentPrismPrice, v1_0_0_dom.prismPriceChange, state.currentPrismPrice, state.lastPrismPrice);

            if (v1_0_0_dom.weatherDisplay) v1_0_0_dom.weatherDisplay.textContent = `${state.weather} ${WEATHER_DATA[state.weather].icon}`;
            
            const computerIncome = state.computerTier > 0 ? [0, 100, 500, 2500, 10000][state.computerTier] : 0;
            const lunarIncome = state.isLunarUpgraded ? 100 : 0;
            const energyIncome = state.isEnergyUpgraded ? 900 : 0;
            const prismIncome = state.isPrismUpgraded ? 5000 : 0;
            const totalIncome = computerIncome + lunarIncome + energyIncome + prismIncome;
            if (v1_0_0_dom.incomePerSecond) v1_0_0_dom.incomePerSecond.textContent = `+${totalIncome.toLocaleString('ko-KR')} KRW / sec`;

            v1_0_0_updateComputerUI();
            v1_0_0_updateAlmanac();
        }
        function v1_0_0_updateComputerUI() {
            if (!v1_0_0_dom.computerTierText || !v1_0_0_dom.computerStatsText || !v1_0_0_dom.computerUpgradeButton) return;
            const tier = gameState.v1_0_0.computerTier;
            const tiers = [
                { name: 'ì»´í“¨í„° ì—†ìŒ', income: 0, cost: 500000, next: 'Tier 1 êµ¬ë§¤' },
                { name: 'Tier 1: êµ¬í˜• ì»´í“¨í„°', income: 100, cost: 2000000, next: 'Tier 2 ì—…ê·¸ë ˆì´ë“œ' },
                { name: 'Tier 2: ìµœì‹ í˜• ì»´í“¨í„°', income: 500, cost: 10000000, next: 'Tier 3 ì—…ê·¸ë ˆì´ë“œ' },
                { name: 'Tier 3: ì „ë¬¸ê°€ìš© ì›Œí¬ìŠ¤í…Œì´ì…˜', income: 2500, cost: 50000000, next: 'Tier 4 ì—…ê·¸ë ˆì´ë“œ' },
                { name: 'Tier 4: ì–‘ì ì»´í“¨í„°', income: 10000, cost: Infinity, next: 'ìµœê³  í‹°ì–´' }
            ];
            v1_0_0_dom.computerTierText.textContent = tiers[tier].name;
            v1_0_0_dom.computerStatsText.textContent = `ì´ˆë‹¹ +${tiers[tier].income.toLocaleString()} KRW ìƒì‚°`;
            if (tier < 4) {
                v1_0_0_dom.computerUpgradeButton.textContent = `${tiers[tier].next} (${tiers[tier].cost.toLocaleString()} KRW)`;
                v1_0_0_dom.computerUpgradeButton.classList.remove('hidden');
            } else {
                v1_0_0_dom.computerUpgradeButton.textContent = tiers[tier].next;
                v1_0_0_dom.computerUpgradeButton.classList.add('hidden');
            }
        }
        function v1_0_0_updateAlmanac() {
            if (!v1_0_0_dom.almanacContent) return;
            v1_0_0_dom.almanacContent.innerHTML = '';
            for (const weather in WEATHER_DATA) {
                const hasExperienced = gameState.v1_0_0.experiencedWeathers[weather];
                const el = document.createElement('div');
                el.className = `bg-gray-600 p-3 rounded-lg flex items-center gap-4 transition-opacity ${hasExperienced ? '' : 'opacity-40'}`;
                el.innerHTML = `
                    <div class="text-2xl">${WEATHER_DATA[weather].icon}</div>
                    <div>
                        <span class="font-bold text-lg">${hasExperienced ? weather : '???'}</span>
                        <p class="text-xs text-gray-400 mt-1">${hasExperienced ? WEATHER_DATA[weather].description : 'ê²½í—˜í•˜ì§€ ì•Šì€ ë‚ ì”¨ì…ë‹ˆë‹¤.'}</p>
                    </div>
                `;
                v1_0_0_dom.almanacContent.appendChild(el);
            }
        }
        function v1_0_0_populateTradeUI() {
            const container = v1_0_0_dom.tradeContainer; if (!container) return; container.innerHTML = '';
            const coins = [
                { id: 'cube', name: 'CUBE', color: 'blue', isLocked: () => false },
                { id: 'lunar', name: 'LUNAR', color: 'purple', isLocked: () => false },
                { id: 'energy', name: 'ENERGY', color: 'yellow', isLocked: () => !gameState.v1_0_0.isEnergyUpgraded },
                { id: 'prism', name: 'PRISM', color: 'pink', isLocked: () => !gameState.v1_0_0.isPrismUpgraded },
            ];
            coins.forEach(coin => {
                const el = document.createElement('div');
                el.id = `v1.0.0-${coin.id}-trade-section`;
                el.className = 'bg-gray-600 p-4 rounded-lg';
                el.innerHTML = `
                    <label class="text-lg font-semibold text-${coin.color}-300">${coin.name} ê±°ë˜</label>
                    <input type="number" id="v1.0.0-amount-input-${coin.id}" value="1" min="1" class="w-full bg-gray-800 text-white p-2 rounded mt-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-${coin.color}-500" placeholder="${coin.name} ìˆ˜ëŸ‰">
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <button id="v1.0.0-buy-button-${coin.id}" class="w-full bg-green-600 hover:bg-green-700 font-bold p-3 rounded-lg">ë§¤ìˆ˜</button>
                        <button id="v1.0.0-sell-button-${coin.id}" class="w-full bg-red-600 hover:bg-red-700 font-bold p-3 rounded-lg">ë§¤ë„</button>
                    </div>
                `;
                container.appendChild(el);
                document.getElementById(`v1.0.0-buy-button-${coin.id}`)?.addEventListener('click', () => v1_0_0_handleTrade('buy', coin.id));
                document.getElementById(`v1.0.0-sell-button-${coin.id}`)?.addEventListener('click', () => v1_0_0_handleTrade('sell', coin.id));
            });
            v1_0_0_updateTradeUI();
        }
        function v1_0_0_updateTradeUI() {
            const updateSection = (id, isLocked) => {
                const section = document.getElementById(`v1.0.0-${id}-trade-section`);
                if (section) section.classList.toggle('hidden', isLocked);
            };
            updateSection('energy', !gameState.v1_0_0.isEnergyUpgraded);
            updateSection('prism', !gameState.v1_0_0.isPrismUpgraded);
        }
        function v1_0_0_populateShopItems() {
            const container = v1_0_0_dom.shopItems; if (!container) return; container.innerHTML = '';
            const items = [
                { id: 'digitalClock', name: 'ë””ì§€í„¸ ì‹œê³„', desc: 'ê²Œì„ ë‚´ ì‹œê°„ê³¼ ë‚ ì”¨ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.', cost: 1000000 },
                { id: 'weatherAlmanac', name: 'ë‚ ì”¨ ë„ê°', desc: 'ì§€ê¸ˆê¹Œì§€ ê²½í—˜í•œ ë‚ ì”¨ì™€ íš¨ê³¼ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.', cost: 5000000 },
                { id: 'bed', name: 'ì¹¨ëŒ€', desc: 'ë°¤ì— ì ì„ ìì„œ ì‹œê°„ì„ ë¹ ë¥´ê²Œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', cost: 2500000 },
            ];
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-600 p-4 rounded-lg';
                el.innerHTML = `
                    <h4 class="font-bold text-lg">${item.name}</h4>
                    <p class="text-xs text-gray-400 mt-1 mb-3 h-10">${item.desc}</p>
                    <button id="v1.0.0-buy-${item.id}" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">
                        ${gameState.v1_0_0.shopItems[item.id] ? 'ë³´ìœ ì¤‘' : `${item.cost.toLocaleString()} KRW`}
                    </button>
                `;
                container.appendChild(el);
                const button = document.getElementById(`v1.0.0-buy-${item.id}`);
                if (button) {
                    if (gameState.v1_0_0.shopItems[item.id]) { 
                        button.disabled = true; button.classList.add('btn-disabled'); 
                    } else { 
                        button.addEventListener('click', () => v1_0_0_handleShopBuy(item.id, item.cost)); 
                    }
                }
            });
        }
        function v1_0_0_handleShopBuy(itemId, cost) {
            const state = gameState.v1_0_0;
            if (state.userCash >= cost) {
                state.userCash -= cost; state.shopItems[itemId] = true;
                v1_0_0_showNotification(`${itemId} êµ¬ë§¤ ì™„ë£Œ!`, false);
                v1_0_0_populateShopItems(); v1_0_0_restoreUIState(); saveGameState();
            } else { v1_0_0_showNotification('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); }
        }
        function v1_0_0_getNewPrice(currentPrice, weather) {
            let riseProb = 0.51, periodAdj = 1.0;
            if (weather === 'ë§‘ìŒ') riseProb += 0.005; else if (weather === 'ë¹„') periodAdj += 0.05; else if (weather === 'êµ¬ë¦„') periodAdj -= 0.05; else if (weather === 'ì‚°ì„±ë¹„') riseProb -= 0.025; else if (weather === 'ì²œë‘¥') riseProb -= 0.005; else if (weather === 'ë¬´ì§€ê°œ') riseProb += 0.05;
            let dir = Math.random() < riseProb ? 1 : -1;
            let mag = Math.random(), pct;
            if (mag < 0.5) pct = (Math.random() * 0.02) + 0.001; else if (mag < 0.95) pct = (Math.random() * 0.05) + 0.021; else pct = (Math.random() * 0.12) + 0.051;
            const newPrice = currentPrice + (currentPrice * pct * dir);
            return Math.max(1, newPrice);
        }

        function v1_0_0_priceUpdateLoop() {
            const state = gameState.v1_0_0;
            if (state.isInternetOutage) { v1_0_0_priceUpdateTimeout = setTimeout(v1_0_0_priceUpdateLoop, 2000); return; }
            const update = (key, chart) => {
                const currentKey = `current${key}Price`, lastKey = `last${key}Price`;
                state[lastKey] = state[currentKey];
                state[currentKey] = Math.round(v1_0_0_getNewPrice(state[currentKey], state.weather));
                v1_0_0_updateChartData(chart, state[currentKey], new Date().toLocaleTimeString('ko-KR'));
            };
            update('Price', v1_0_0_chartCube); update('LunarPrice', v1_0_0_chartLunar); update('EnergyPrice', v1_0_0_chartEnergy); update('PrismPrice', v1_0_0_chartPrism);
            let interval = 2000;
            if (state.weather === 'ë¹„') interval *= 1.05; if (state.weather === 'êµ¬ë¦„') interval *= 0.95;
            v1_0_0_priceUpdateTimeout = setTimeout(v1_0_0_priceUpdateLoop, interval);
        }

        function v1_0_0_gameLoop() {
            const state = gameState.v1_0_0;
            state.weatherCounter++;
            if (state.weatherCounter >= 120) { // 30ì´ˆë§ˆë‹¤ ë‚ ì”¨ ë³€ê²½ (250ms * 120)
                state.weatherCounter = 0; state.lastWeather = state.weather;
                let possibleWeathers = ['ë§‘ìŒ', 'ë¹„', 'êµ¬ë¦„'];
                if (Math.random() < 0.1) possibleWeathers.push('ì‚°ì„±ë¹„');
                if (Math.random() < 0.1) possibleWeathers.push('ì²œë‘¥');
                if (state.nextWeatherIsRainbow || Math.random() < 0.05) { state.weather = 'ë¬´ì§€ê°œ'; state.nextWeatherIsRainbow = false; } 
                else if (state.lastWeather === 'ë¹„' && Math.random() < 0.1) { state.nextWeatherIsRainbow = true; state.weather = possibleWeathers[Math.floor(Math.random() * possibleWeathers.length)]; } 
                else { state.weather = possibleWeathers[Math.floor(Math.random() * possibleWeathers.length)]; }
                state.experiencedWeathers[state.weather] = true;
            }
            if (state.weather === 'ì²œë‘¥' && Math.random() < 0.005) state.isInternetOutage = true; 
            else if (state.isInternetOutage && state.weather !== 'ì²œë‘¥') state.isInternetOutage = false;
            if (v1_0_0_dom.internetOutage) v1_0_0_dom.internetOutage.classList.toggle('hidden', !state.isInternetOutage);
            if (!state.isSleeping) {
                const computerIncome = state.computerTier > 0 ? [0, 100, 500, 2500, 10000][state.computerTier] : 0;
                const lunarIncome = state.isLunarUpgraded ? 100 : 0;
                const energyIncome = state.isEnergyUpgraded ? 900 : 0;
                const prismIncome = state.isPrismUpgraded ? 5000 : 0;
                state.userCash += (computerIncome + lunarIncome + energyIncome + prismIncome) / 4;
            }
            v1_0_0_updateUI();
        }

        function v1_0_0_handleTrade(type, coinId) {
            const state = gameState.v1_0_0;
            const amountInput = document.getElementById(`v1.0.0-amount-input-${coinId}`);
            if (!amountInput) return; const amount = parseInt(amountInput.value); if (!(amount > 0)) return;
            const prices = { cube: state.currentPrice, lunar: state.currentLunarPrice, energy: state.currentEnergyPrice, prism: state.currentPrismPrice };
            const coinData = { cube: { balance: 'userCubes' }, lunar: { balance: 'userLunar' }, energy: { balance: 'userEnergy' }, prism: { balance: 'userPrisms' } };
            const cost = prices[coinId] * amount, coinUpper = coinId.toUpperCase();

            if (type === 'buy') {
                if (state.userCash >= cost) { state.userCash -= cost; state[coinData[coinId].balance] += amount; v1_0_0_showNotification(`${amount} ${coinUpper} ë§¤ìˆ˜!`, false); } 
                else { v1_0_0_showNotification('í˜„ê¸ˆ ë¶€ì¡±', true); return; }
            } else {
                if (state[coinData[coinId].balance] >= amount) { state.userCash += cost; state[coinData[coinId].balance] -= amount; v1_0_0_showNotification(`${amount} ${coinUpper} ë§¤ë„!`, false); } 
                else { v1_0_0_showNotification(`${coinUpper} ë¶€ì¡±`, true); return; }
            }
            v1_0_0_updateUI(); saveGameState();
        }
        function v1_0_0_handleBuy3DCube() { const state = gameState.v1_0_0; if (state.userCash >= 1000000) { state.userCash -= 1000000; state.isCubePurchased = true; v1_0_0_restoreUIState(); v1_0_0_showNotification('3D íë¸Œ êµ¬ë§¤ ì™„ë£Œ!', false); v1_0_0_updateUI(); saveGameState(); } else { v1_0_0_showNotification('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); } }
        function v1_0_0_handleComputerUpgrade() {
            const state = gameState.v1_0_0;
            const costs = [500000, 2000000, 10000000, 50000000];
            if (state.computerTier >= 4) return;
            const cost = costs[state.computerTier];
            if (state.userCash >= cost) {
                state.userCash -= cost; state.computerTier++;
                v1_0_0_showNotification(`ì»´í“¨í„° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ! (Tier ${state.computerTier})`, false);
                v1_0_0_updateComputerUI(); saveGameState();
            } else { v1_0_0_showNotification('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', true); }
        }
        function v1_0_0_handleSleep() {
            const state = gameState.v1_0_0;
            if (state.isSleeping) return;
            state.isSleeping = true;
            v1_0_0_showNotification('ìˆ˜ë©´ì„ ì‹œì‘í•©ë‹ˆë‹¤... (8ë°°ì†)', false);
            if (v1_0_0_dom.sleepButton) v1_0_0_dom.sleepButton.textContent = 'ìˆ˜ë©´ ì¤‘...';
            
            // Simulate time passing faster by running the game loop more frequently for a period
            let sleepCounter = 0;
            const sleepInterval = setInterval(() => {
                v1_0_0_gameLoop();
                sleepCounter++;
                if (sleepCounter >= 8 * 120) { // Simulate 8 hours (8 * 30 seconds)
                    clearInterval(sleepInterval);
                    state.isSleeping = false;
                    v1_0_0_showNotification('ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤!', false);
                    if (v1_0_0_dom.sleepButton) v1_0_0_dom.sleepButton.textContent = 'ìˆ˜ë©´';
                    v1_0_0_updateUI();
                    saveGameState();
                }
            }, 250 / 8); // 8 times faster
        }

        function v1_0_0_switchChart(chartName) { const charts = ['cube', 'lunar', 'energy', 'prism']; charts.forEach(c => { v1_0_0_dom[`chart${c.charAt(0).toUpperCase() + c.slice(1)}Container`].classList.toggle('hidden', c !== chartName); v1_0_0_dom[`chartTab${c.charAt(0).toUpperCase() + c.slice(1)}`].classList.toggle('tab-active', c === chartName); }); }
        function v1_0_0_restoreUIState() {
            const state = gameState.v1_0_0;
            if (!v1_0_0_dom.cubePurchaseOverlay) return;
            v1_0_0_dom.cubePurchaseOverlay.classList.toggle('hidden', state.isCubePurchased);
            v1_0_0_dom.passiveIncomeDisplay.classList.toggle('hidden', !state.isCubePurchased);
            
            v1_0_0_dom.timeContainer.classList.toggle('hidden', !state.shopItems.digitalClock);
            v1_0_0_dom.weatherContainer.classList.toggle('hidden', !state.shopItems.digitalClock);
            v1_0_0_dom.almanacSection.classList.toggle('hidden', !state.shopItems.weatherAlmanac);
            v1_0_0_dom.sleepSection.classList.toggle('hidden', !state.shopItems.bed);

            v1_0_0_updateTradeUI();
            v1_0_0_updateUI();
        }

        // =======================================================
        // ê³µìš© ë¡œì§ (ì¸ì¦, ë²„ì „ ê´€ë¦¬ ë“±)
        // =======================================================
        function handleCodeSubmit() {
            const input = document.getElementById(`${currentVersion}-code-input`);
            if (!input) return;
            const code = input.value.trim().toUpperCase();
            const showNoti = currentVersion === 'v0.3.0' ? v0_3_0_showNotification : v1_0_0_showNotification;

            if (gameState.shared.usedCodes.includes(code)) {
                showNoti('ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì…ë‹ˆë‹¤.', true);
                return;
            }

            let rewardGiven = false;
            if (code === 'TWILIGHT' && currentVersion === 'v0.3.0') {
                gameState.shared.hasTwilightTrophy = true;
                showNoti('ì¹˜íŠ¸ ì½”ë“œ: í™©í˜¼ì˜ íŠ¸ë¡œí”¼ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', false);
                rewardGiven = true;
            } else if (code === 'SORRY4RESET' && currentVersion === 'v0.3.0') {
                const state = gameState.v0_3_0;
                state.userLunar += 4;
                showNoti('ë³´ìƒ ì½”ë“œ: 4 LUNARë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', false);
                rewardGiven = true;
            } else if (code === 'MONEYBAGS') {
                const state = currentVersion === 'v0.3.0' ? gameState.v0_3_0 : gameState.v1_0_0;
                state.userCash += 1000000;
                showNoti('ì¹˜íŠ¸ ì½”ë“œ: 1,000,000 KRWê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', false);
                rewardGiven = true;
            } else if (code === 'UPGRADE') {
                 const state = gameState.v1_0_0;
                 state.isEnergyUpgraded = true;
                 state.isPrismUpgraded = true;
                 v1_0_0_populateShopItems();
                 v1_0_0_restoreUIState();
                 showNoti('ì¹˜íŠ¸ ì½”ë“œ: ëª¨ë“  ì½”ì¸ ì—…ê·¸ë ˆì´ë“œ ì ê¸ˆ í•´ì œ!', false);
                 rewardGiven = true;
            } else if (code === 'PREVIEW' && !gameState.shared.v0_4_0_preview_used) {
                gameState.shared.v0_4_0_preview_used = true;
                gameState.shared.v0_4_0_preview_end_time = Date.now() + 5 * 60 * 1000;
                showNoti('v.0.4.0 5ë¶„ í”„ë¦¬ë·°ê°€ ì‹œì‘ë©ë‹ˆë‹¤!', false);
                startPreviewTimer(gameState.shared.v0_4_0_preview_end_time);
                rewardGiven = true;
            } else {
                showNoti('ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.', true);
            }
            
            if (rewardGiven) {
                gameState.shared.usedCodes.push(code);
                input.value = '';
                if (currentVersion === 'v0.3.0') v0_3_0_updateUI(); else v1_0_0_updateUI();
                saveGameState();
            }
        }

        function startPreviewTimer(endTime) {
            const banner = document.getElementById('preview-timer-banner');
            const timerEl = document.getElementById('preview-timer');
            if (!banner || !timerEl) return;
            
            banner.classList.remove('hidden');

            if (previewTimerInterval) clearInterval(previewTimerInterval);
            previewTimerInterval = window.setInterval(() => {
                const remaining = endTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(previewTimerInterval);
                    banner.classList.add('hidden');
                    gameState.shared.v0_4_0_preview_end_time = 0;
                    switchVersion('v0.3.0'); // ì‹œê°„ì´ ë‹¤ ë˜ë©´ ì´ì „ ë²„ì „ìœ¼ë¡œ ê°•ì œ ì „í™˜
                    v0_3_0_showNotification('í”„ë¦¬ë·° ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                    saveGameState();
                    return;
                }
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function initCountdownBanner() {
            const banner = document.getElementById('countdown-banner');
            const timer = document.getElementById('countdown-timer');
            const codeAnnouncement = document.getElementById('code-announcement');
            if (!banner || !timer) return;

            const updateCountdown = () => {
                const now = new Date().getTime();
                const distance = V0_4_0_RELEASE_DATE.getTime() - now;

                if (distance < 5 * 60 * 60 * 1000) { // 5ì‹œê°„ ì „
                     banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                    return;
                }

                if (distance <= 0) {
                    clearInterval(window.countdownInterval);
                    banner.innerHTML = 'v.0.4.0 ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timer.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
                
                // 1ì‹œê°„ ì „ë¶€í„° ì½”ë“œ ì•ˆë‚´
                if (distance < 1 * 60 * 60 * 1000) {
                    codeAnnouncement.classList.remove('hidden');
                    codeAnnouncement.textContent = 'íŒíŠ¸: ì—…ë°ì´íŠ¸ í›„ ì½”ë“œë¥¼ ì…ë ¥í•˜ì—¬ íŠ¹ë³„í•œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”! ì½”ë“œ: UPGRADE';
                }

            };

            updateCountdown();
            window.countdownInterval = window.setInterval(updateCountdown, 1000);
        }

        function init3D() {
            const container = document.getElementById(`${currentVersion}-canvas-container`);
            if (!container) return;
            
            // ì´ì „ ë Œë”ëŸ¬ê°€ ìˆë‹¤ë©´ ì œê±°
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.BoxGeometry(2, 2, 2);
            cubeMaterial = new THREE.MeshStandardMaterial({ color: 0x60a5fa, metalness: 0.5, roughness: 0.5 });
            cube = new THREE.Mesh(geometry, cubeMaterial);
            scene.add(cube);
            
            ambientLight = new THREE.AmbientLight(0xcccccc, 0.7);
            scene.add(ambientLight);
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            camera.position.z = 5;

            const animate = () => {
                if (!document.getElementById(`${currentVersion}-canvas-container`)) return; // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
                requestAnimationFrame(animate);
                if (cube) {
                    cube.rotation.x += 0.005;
                    cube.rotation.y += 0.005;
                }
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                if (container) {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
            });
        }

        function switchVersion(version) {
            if (currentVersion === version) return;

            // í˜„ì¬ ë²„ì „ì˜ ê²Œì„ ë£¨í”„/íƒ€ì´ë¨¸ ì •ë¦¬
            if (currentVersion === 'v0.3.0') {
                if (v0_3_0_gameLoopTimeout) clearTimeout(v0_3_0_gameLoopTimeout);
                if (v0_3_0_priceUpdateTimeout) clearTimeout(v0_3_0_priceUpdateTimeout);
            } else if (currentVersion === 'v1.0.0') {
                if (v1_0_0_gameLoopInterval) clearInterval(v1_0_0_gameLoopInterval);
                if (v1_0_0_priceUpdateTimeout) clearTimeout(v1_0_0_priceUpdateTimeout);
            }

            currentVersion = version;

            document.getElementById('v0.3.0-container').classList.toggle('hidden', version !== 'v0.3.0');
            document.getElementById('v1.0.0-container').classList.toggle('hidden', version !== 'v1.0.0');
            
            init3D();

            if (version === 'v0.3.0') {
                initV0_3_0_Game();
                v0_3_0_startGame();
            } else if (version === 'v1.0.0') {
                initV1_0_0_Game();
                v1_0_0_startGame();
            }
        }
        async function saveGameState() {
            if (!currentUser) {
                console.error("ì €ì¥ ì‹¤íŒ¨: ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            try {
                await db.collection('users').doc(currentUser).set(gameState);
            } catch (error) {
                console.error("Firebaseì— ê²Œì„ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", error);
            }
        }

        async function loadGameState(uid) {
            try {
                const docRef = db.collection('users').doc(uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const loadedData = docSnap.data();
                    // ë°ì´í„° ë³‘í•© (ìƒˆë¡œìš´ ì†ì„±ì´ ì¶”ê°€ë˜ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                    const initialState = getInitialGameState();
                    gameState = {
                        ...initialState,
                        ...loadedData,
                        v0_3_0: { ...initialState.v0_3_0, ...loadedData.v0_3_0 },
                        v1_0_0: { ...initialState.v1_0_0, ...loadedData.v1_0_0 },
                        shared: { ...initialState.shared, ...loadedData.shared },
                    };
                    return true;
                } else {
                    console.log("ê¸°ì¡´ ë°ì´í„° ì—†ìŒ. ìƒˆ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
                    gameState = getInitialGameState();
                    // ìƒˆ ì‚¬ìš©ìë¥¼ ìœ„í•´ ì´ˆê¸° ìƒíƒœë¥¼ ì €ì¥
                    await saveGameState();
                    return false;
                }
            } catch (error) {
                console.error("Firebaseì—ì„œ ê²Œì„ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                gameState = getInitialGameState();
                return false;
            }
        }
        // =======================================================
        // ì¸ì¦ ë¡œì§
        // =======================================================
        function setupAuthUI() {
            auth_dom = {
                modal: document.getElementById('login-modal'),
                mainContent: document.getElementById('main-content'),
                loginForm: document.getElementById('login-form'),
                signupForm: document.getElementById('signup-form'),
                loginEmailInput: document.getElementById('login-email'),
                loginPasswordInput: document.getElementById('login-password'),
                loginSubmitButton: document.getElementById('login-submit-button'),
                signupEmailInput: document.getElementById('signup-email'),
                signupPasswordInput: document.getElementById('signup-password'),
                signupSubmitButton: document.getElementById('signup-submit-button'),
                showSignupButton: document.getElementById('show-signup-button'),
                showLoginButton: document.getElementById('show-login-button'),
                errorMessage: document.getElementById('auth-error-message'),
            };

            auth_dom.showSignupButton.addEventListener('click', () => {
                auth_dom.loginForm.classList.add('hidden');
                auth_dom.signupForm.classList.remove('hidden');
                auth_dom.errorMessage.textContent = '';
            });

            auth_dom.showLoginButton.addEventListener('click', () => {
                auth_dom.signupForm.classList.add('hidden');
                auth_dom.loginForm.classList.remove('hidden');
                auth_dom.errorMessage.textContent = '';
            });

            auth_dom.loginSubmitButton.addEventListener('click', handleLogin);
            auth_dom.signupSubmitButton.addEventListener('click', handleSignup);
        }

        function getKoreanAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'í•´ë‹¹ ì´ë©”ì¼ë¡œ ê°€ì…ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
                case 'auth/wrong-password':
                    return 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
                case 'auth/invalid-email':
                    return 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                case 'auth/email-already-in-use':
                    return 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.';
                case 'auth/weak-password':
                    return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                case 'auth/too-many-requests':
                    return 'ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                default:
                    return 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }
        }


        function handleLogin() {
            const email = auth_dom.loginEmailInput.value;
            const password = auth_dom.loginPasswordInput.value;
            auth_dom.errorMessage.textContent = '';

            if (!email || !password) {
                auth_dom.errorMessage.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    auth_dom.errorMessage.textContent = getKoreanAuthErrorMessage(error.code);
                });
        }

        function handleSignup() {
            const email = auth_dom.signupEmailInput.value;
            const password = auth_dom.signupPasswordInput.value;
            auth_dom.errorMessage.textContent = '';

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                auth_dom.errorMessage.textContent = 'ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                return;
            }

            if (password.length < 6) {
                auth_dom.errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // ìƒˆ ìœ ì €ë¥¼ ìœ„í•œ ì´ˆê¸° ë°ì´í„° ìƒì„±
                    currentUser = userCredential.user.uid;
                    gameState = getInitialGameState();
                    return saveGameState();
                })
                .then(() => {
                     // íšŒì›ê°€ì… ì„±ê³µ í›„ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ì „í™˜
                    v0_3_0_showNotification('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.', false);
                    auth_dom.signupForm.classList.add('hidden');
                    auth_dom.loginForm.classList.remove('hidden');
                    auth_dom.loginEmailInput.value = email;
                    auth_dom.loginPasswordInput.value = '';
                })
                .catch(error => {
                    auth_dom.errorMessage.textContent = getKoreanAuthErrorMessage(error.code);
                });
        }


        function handleLogout() {
            auth.signOut();
        }

        function stopAllGameLoops() {
            if (v0_3_0_gameLoopTimeout) clearTimeout(v0_3_0_gameLoopTimeout);
            if (v0_3_0_priceUpdateTimeout) clearTimeout(v0_3_0_priceUpdateTimeout);
            if (v1_0_0_gameLoopInterval) clearInterval(v1_0_0_gameLoopInterval);
            if (v1_0_0_priceUpdateTimeout) clearTimeout(v1_0_0_priceUpdateTimeout);
            if (window.autosaveInterval) clearInterval(window.autosaveInterval);
            if (previewTimerInterval) clearInterval(previewTimerInterval);
            
            v0_3_0_gameLoopTimeout = null;
            v0_3_0_priceUpdateTimeout = null;
            v1_0_0_gameLoopInterval = null;
            v1_0_0_priceUpdateTimeout = null;
            window.autosaveInterval = null;
            previewTimerInterval = null;
        }

        // =======================================================
        // ì•± ì´ˆê¸°í™”
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            setupAuthUI();
            initCountdownBanner();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user.uid;
                    await loadGameState(user.uid);

                    auth_dom.modal.classList.add('hidden');
                    auth_dom.mainContent.classList.remove('hidden');
                    
                    // í”„ë¦¬ë·° íƒ€ì´ë¨¸ ë³µì›
                    if (gameState.shared.v0_4_0_preview_end_time > Date.now()) {
                        startPreviewTimer(gameState.shared.v0_4_0_preview_end_time);
                        switchVersion('v1.0.0');
                    } else {
                        switchVersion('v0.3.0');
                    }

                    if (window.autosaveInterval) clearInterval(window.autosaveInterval);
                    window.autosaveInterval = setInterval(saveGameState, 30000); // 30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥

                } else {
                    currentUser = null;
                    auth_dom.modal.classList.remove('hidden');
                    auth_dom.mainContent.classList.add('hidden');
                    stopAllGameLoops();
                }
            });
        });
    </script>
</body>
</html>
